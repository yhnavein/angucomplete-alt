/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd?define(["angular"],b):b(a.angular)}(window,function(a){a.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache","$interpolate",function(b,c,d,e,f,g,h){function i(c,g,h,i){function w(a,b){a&&("object"==typeof a?(c.searchStr=C(a),z({originalObject:a})):"string"==typeof a&&a.length>0?c.searchStr=a:console&&console.error&&console.error("Tried to set "+(b?"initial":"")+" value of angucomplete to",a,"which is an invalid value"),F(!0))}function x(a){ma=null,c.hideResults(a),document.body.removeEventListener("click",x)}function y(a){return a.which?a.which:a.keyCode}function z(a){"function"==typeof c.selectedObject?c.selectedObject(a):c.selectedObject=a?a.originalObject:null,F(a?!0:!1)}function A(a){return function(b){return c[a]?c[a](b):b}}function B(a){z({originalObject:a}),c.clearSelected&&(c.searchStr=null),U()}function C(a){return c.titleField.split(",").map(function(b){return D(a,b)}).join(" ")}function D(a,b){var c,d;if(b){c=b.split("."),d=a;for(var e=0;e<c.length;e++)d=d[c[e]]}else d=a;return d}function E(a,b){var d,f,g;return g=new RegExp(b.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),a?(a.match&&a.replace||(a=a.toString()),f=a.match(g),d=f?a.replace(g,'<span class="'+c.matchClass+'">'+f[0]+"</span>"):a,e.trustAsHtml(d)):null}function F(a){c.notEmpty=a,ia=c.searchStr,c.fieldRequired&&i&&c.inputName&&i[c.inputName].$setValidity(ha,a)}function G(a){var b=y(a);if(b!==m&&b!==k)if(b===l||b===o)a.preventDefault();else if(b===j)a.preventDefault(),!c.showDropdown&&c.searchStr&&c.searchStr.length>=fa&&(V(),c.searching=!0,Y(c.searchStr));else if(b===n)U(),c.$apply(function(){ea.val(c.searchStr)});else{if(0===fa&&!c.searchStr)return;c.searchStr&&""!==c.searchStr?c.searchStr.length>=fa&&(V(),ga&&f.cancel(ga),c.searching=!0,ga=f(function(){Y(c.searchStr)},c.pause)):c.showDropdown=!1,ia&&ia!==c.searchStr&&!c.clearSelected&&c.$apply(function(){z()})}}function H(a){!c.overrideSuggestions||c.selectedObject&&c.selectedObject.originalObject===c.searchStr||(a&&a.preventDefault(),f.cancel(ga),R(),B(c.searchStr))}function I(a){var b=getComputedStyle(a);return a.offsetHeight+parseInt(b.marginTop,10)+parseInt(b.marginBottom,10)}function J(){return ka.getBoundingClientRect().top+parseInt(getComputedStyle(ka).maxHeight,10)}function K(){return g[0].querySelectorAll(".angucomplete-row")[c.currentIndex]}function L(){return K().getBoundingClientRect().top-(ka.getBoundingClientRect().top+parseInt(getComputedStyle(ka).paddingTop,10))}function M(a){ka.scrollTop=ka.scrollTop+a}function N(){var a=c.results[c.currentIndex];c.matchClass?ea.val(C(a.originalObject)):ea.val(a.title)}function O(b){var d=y(b),e=null,f=null;d===o&&c.results&&c.results.length>0?(c.currentIndex>=0&&c.currentIndex<c.results.length?(b.preventDefault(),c.selectResult(c.results[c.currentIndex])):(H(b),U()),c.$apply()):d===o&&c.searchStr.length>0&&0===c.results.length?((c.onAddNewClick||a.noop)(),U(),c.$apply()):d===j&&c.results?(b.preventDefault(),c.currentIndex+1<c.results.length&&c.showDropdown&&(c.$apply(function(){c.currentIndex++,N()}),la&&(e=K(),J()<e.getBoundingClientRect().bottom&&M(I(e))))):d===l&&c.results?(b.preventDefault(),c.currentIndex>=1?(c.$apply(function(){c.currentIndex--,N()}),la&&(f=L(),0>f&&M(f-1))):0===c.currentIndex&&c.$apply(function(){c.currentIndex=-1,ea.val(c.searchStr)})):d===p?c.results&&c.results.length>0&&c.showDropdown?-1===c.currentIndex&&c.overrideSuggestions?H():(-1===c.currentIndex&&(c.currentIndex=0),c.selectResult(c.results[c.currentIndex]),c.$digest()):c.searchStr&&c.searchStr.length>0&&H():d===n&&b.preventDefault()}function P(a){return function(b,d,e,f){d||e||f||!b.data||(b=b.data),c.searching=!1,Z(D(aa(b),c.remoteUrlDataField),a)}}function Q(a,b,d,e){0!==b&&-1!==b&&(b||d||e||(b=a.status),c.remoteUrlErrorCallback?c.remoteUrlErrorCallback(a,b,d,e):console&&console.error&&console.error("http error"))}function R(){ja&&ja.resolve()}function S(a){var e={},f=c.remoteUrl+encodeURIComponent(a);c.remoteUrlRequestFormatter&&(e={params:c.remoteUrlRequestFormatter(a)},f=c.remoteUrl),c.remoteUrlRequestWithCredentials&&(e.withCredentials=!0),R(),ja=b.defer(),e.timeout=ja.promise,d.get(f,e).success(P(a)).error(Q)}function T(a){R(),ja=b.defer(),c.remoteApiHandler(a,ja.promise).then(P(a))["catch"](Q)}function U(){c.showDropdown=!1,c.results=[],ka&&(ka.scrollTop=0)}function V(){c.showDropdown=ca,c.currentIndex=c.focusFirst?0:-1,c.results=[]}function W(a){var b,d,e,f,g=c.searchFields.split(","),h=[];for("undefined"!=typeof c.parseInput()&&(a=c.parseInput()(a)),b=0;b<c.localData.length;b++){for(d=!1,e=0;e<g.length;e++)f=D(c.localData[b],g[e])||"",d=d||f.toString().toLowerCase().indexOf(a.toString().toLowerCase())>=0;d&&(h[h.length]=c.localData[b])}c.searching=!1,Z(h,a)}function X(a,b,d){if(!d)return!1;for(var e in b)if(b[e].toLowerCase()===d.toLowerCase())return c.selectResult(a),!0;return!1}function Y(a){!a||a.length<fa||(c.localData?c.$apply(function(){W(a)}):c.remoteApiHandler?T(a):S(a))}function Z(a,b){var d,e,f,g,h,i;if(a&&a.length>0)for(c.results=[],d=0;d<a.length;d++)c.titleField&&""!==c.titleField&&(g=h=C(a[d])),e="",c.descriptionField&&(e=i=D(a[d],c.descriptionField)),f="",c.imageField&&(f=D(a[d],c.imageField)),c.matchClass&&(h=E(g,b),i=E(e,b)),c.results[c.results.length]={title:h,description:i,image:f,originalObject:a[d]};else c.results=[];c.autoMatch&&1===c.results.length&&X(c.results[0],{title:g,desc:e||""},c.searchStr)?c.showDropdown=!1:0!==c.results.length||da?c.showDropdown=!0:c.showDropdown=!1}function $(){c.localData?Z(c.localData,""):c.remoteApiHandler?T(""):S("")}var _,aa,ba,ca,da,ea=g.find("input"),fa=q,ga=null,ha=u,ia=null,ja=null,ka=g[0].querySelector(".angucomplete-dropdown"),la=!1,ma=null;g.on("mousedown",function(a){a.target.id?(ma=a.target.id,ma===c.id+"_dropdown"&&document.body.addEventListener("click",x)):ma=a.target.className}),c.currentIndex=c.focusFirst?0:null,c.searching=!1,ba=c.$watch("initialValue",function(a){a&&(ba(),w(a,!0))}),c.$watch("fieldRequired",function(a,b){a!==b&&(a?F(ia&&-1!==c.currentIndex?!0:!1):i[c.inputName].$setValidity(ha,!0))}),c.$watch("selectedObject",function(a,b){!a&&b?c.searchStr="":a&&(c.searchStr=a.name)}),c.clearSelection=function(){c.$emit("angucomplete-alt:clearInput"),f(function(){g.find("input").focus()},10)},c.$on("angucomplete-alt:clearInput",function(a,b){b&&b!==c.id||(c.searchStr=null,z(),F(!1),U())}),c.$on("angucomplete-alt:changeInput",function(a,b,d){b&&b===c.id&&w(d)}),c.onFocusHandler=function(){c.focusIn&&c.focusIn(),0!==fa||c.searchStr&&0!==c.searchStr.length||(c.currentIndex=c.focusFirst?0:c.currentIndex,c.showDropdown=!0,$())},c.hideResults=function(){ma&&(ma===c.id+"_dropdown"||ma.indexOf("angucomplete")>=0)?ma=null:(_=f(function(){U(),c.$apply(function(){c.searchStr&&c.searchStr.length>0&&ea.val(c.searchStr)})},t),R(),c.focusOut&&c.focusOut(),c.overrideSuggestions&&c.searchStr&&c.searchStr.length>0&&-1===c.currentIndex&&H())},c.resetHideResults=function(){_&&f.cancel(_)},c.hoverRow=function(a){c.currentIndex=a},c.selectResult=function(b){c.matchClass&&(b.title=C(b.originalObject),b.description=D(b.originalObject,c.descriptionField)),c.clearSelected?c.searchStr=null:c.searchStr=b.title,c.focusNextInput&&a.element(c.focusNextInput).focus(),z(b),U()},c.inputChangeHandler=function(a){return a.length<fa?(R(),U()):0===a.length&&0===fa&&(c.searching=!1,$()),c.inputChanged&&(a=c.inputChanged(a)),a},c.fieldRequiredClass&&""!==c.fieldRequiredClass&&(ha=c.fieldRequiredClass),c.minlength&&""!==c.minlength&&(fa=parseInt(c.minlength,10)),c.pause||(c.pause=s),c.clearSelected||(c.clearSelected=!1),c.overrideSuggestions||(c.overrideSuggestions=!1),c.fieldRequired&&i&&F(c.initialValue?!0:!1),c.inputType=h.type?h.type:"text",c.textNoResults=h.textNoResults?h.textNoResults:v,ca="false"===c.textSearching?!1:!0,da="false"===c.textNoResults?!1:!0,c.maxlength=h.maxlength?h.maxlength:r,ea.on("keydown",O),ea.on("keyup",G),aa=A("remoteUrlResponseFormatter"),f(function(){var a=getComputedStyle(ka);la=a.maxHeight&&"auto"===a.overflowY})}var j=40,k=39,l=38,m=37,n=27,o=13,p=9,q=3,r=524288,s=500,t=200,u="autocomplete-required",v="No results found",w="/angucomplete-alt/index.html";return g.put(w,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name="{{inputName}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput || selectedObject" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown && !selectedObject">    <div class="angucomplete-no-results" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div>  <div class="controls">    <span class="angucomplete-loading" ng-show="searching"></span>    <a class="angucomplete-clear" ng-show="selectedObject" ng-click="clearSelection()"><i class="material-icon md-bold">clear</i></a>    <a class="angucomplete-add-new" ng-show="!selectedObject && searchStr.length > 0" ng-click="onAddNewClick()"><i class="material-icon md-bold">add</i></a>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"=",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",inputName:"@",focusFirst:"@",parseInput:"&",searchStr:"=",onAddNewClick:"&",focusNextInput:"@"},templateUrl:function(a,b){return b.templateUrl||w},compile:function(a){var b=h.startSymbol(),c=h.endSymbol();if("{{"!==b||"}}"!==c){var d=a.html().replace(/\{\{/g,b).replace(/\}\}/g,c);a.html(d)}return i}}}])});